---
tags: SQL
---
Транзакция – это единица работы с данными в рамках соединения с базой данных.

Имеет ДВА состояния:
- Выполняется полностью – commit
- Откатывается полностью – rollback

**ACID** – это набор свойств, которыми должна обладать каждая транзакция БД.
![[Принцип ACID.png]]

[Что такое ACID? | Самый частый вопрос бэкендеру - YouTube](https://youtu.be/gOB3hpAVIIQ)
## Atomicity
Атомарность. Когда нужно выполнить несколько операций в базе данных и вы не хотите, чтобы эти записи были сделаны частично

>[!example]+ Перевод денег со счета на счет (транзакция) 
>Перевод состоит из уменьшение баланса на одном аккаунте и увеличение его на другом (упрощённо). Для этого мы делаем 2 sql-запроса. Если между этими запросами случится ошибка денежки просто исчезнут в никуда. Но если эти два запроса завернуть в транзакцию, то база данных либо выполнит оба запроса, либо не выполнит ничего.

Также подходит термин Abortability - возможность прервать транзакцию без ущерба для консистентности данных.
## Consistency
Консистентность есть несколько значений

>[!Info]+ В распределенных системах хранения
>Eventualy consistency когда-нибудь данные дойдут до всех удалённых репликаций бд (Асинхронная репликация)
>**Consistent hashig** - алгоритм, который используется для перебалансировки данных по серверам
>**CAP теорема** - ==посмотреть когда-нибудь==

**В рамках ASID термин consistency имеет другое значение, нежели чем в распределенных системах хранения**

В ASID consistency означает что данные находятся в некотором "good state" состоянии. Т.е. выполняется набор правил (инвариантов). Например, уникальность данных, ограничение на длину строк и верхняя граница числового значения.

Правило consistency - если до выполнения транзакции система находилась в консистентном состоянии, то и после выполнения транзакции она должна остаться в консистентном состоянии.

>[!note] База данных не гарантирует выполнение этого правила
>За этим должно следить приложение
## Isolation
Часто с базой данных работает несколько пользователей одновременно.
Для того чтобы транзакции не мешали друг другу в транзакционных бд существуют механизмы изоляции транзакций (уровни изоляции)
### Уровни изолированности транзакций
Уровень изолированности транзакций — условное значение, определяющее, в какой мере в результате выполнения логически параллельных транзакций в СУБД допускается получение несогласованных данных.
**Serializable** - очередь из транзакций, последовательное их выполнение. Низкая производительность
**Read commited** - одна транзакция видит изменения, которые сделала другая концепция с помощью команды commit. [[Опасности использования read committed]]
**[[Repetable read или snapshot isolation]]**


| Уровень изоляции | Фантомное чтение | Неповторяющееся чтение | «Грязное» чтение | Потерянное обновление |
|------------------|------------------|------------------------|------------------|-----------------------|
| SERIALIZABLE     |    ✅              |    ✅                    |      ✅            |    ✅                   |
| REPEATABLE READ  | ❌               |   ✅                     |     ✅             |     ✅                  |
| READ COMMITTED   | ❌                | ❌                      |    ✅              |    ✅                   |
| READ UNCOMMITTED | ❌                | ❌                      | ❌                |✅

### Проблемы в многопользовательских БД
 **Фантомное чтение (Phantom Read)**: Это явление, когда во время параллельных транзакций одна транзакция выполняет чтение данных, а затем другая транзакция вставляет или удаляет записи, из-за чего первая транзакция видит новые строки при следующем чтении, "появляются" "фантомные" записи.

**Неповторяющееся чтение (Non-repeatable Read)**: Это ситуация, когда во время выполнения транзакции одни и те же данные читаются дважды, но в интервале между чтениями другая транзакция изменяет или удаляет эти данные, таким образом, первая транзакция видит разные значения при последующем чтении.
**[[Грязное чтение]]** - Когда одна транзакция видит незакомиченные изменение другой транзакции.
**[[Lost Update]]** Потерянное обновление
## Durability
В контексте облака - сохранность данных, то как они реплицируются
В контексте ACID - после коммита данные находятся на постоянном хранилище, а не во временной памяти
![[Транзакции, принцип ACID-1.png]]
